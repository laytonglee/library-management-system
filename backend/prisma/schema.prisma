// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Roles ───────────────────────────────────────────────────────────────────
model Role {
  id          Int      @id @default(autoincrement())
  name        String   @unique // student | teacher | librarian | admin
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  users            User[]
  borrowingPolicies BorrowingPolicy[]

  @@map("roles")
}

// ─── Users ───────────────────────────────────────────────────────────────────
model User {
  id           Int      @id @default(autoincrement())
  fullName     String   @map("full_name")
  username     String   @unique
  email        String   @unique
  passwordHash String   @map("password_hash")
  roleId       Int      @map("role_id")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  role                  Role                   @relation(fields: [roleId], references: [id])
  borrowingTransactions BorrowingTransaction[] @relation("Borrower")
  processedTransactions BorrowingTransaction[] @relation("Librarian")
  notifications         Notification[]
  auditLogs             AuditLog[]
  generatedReports      Report[]

  @@map("users")
}

// ─── Categories ──────────────────────────────────────────────────────────────
model Category {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?

  books Book[]

  @@map("categories")
}

// ─── Books ───────────────────────────────────────────────────────────────────
model Book {
  id              Int      @id @default(autoincrement())
  title           String
  author          String
  isbn            String?  @unique
  categoryId      Int?     @map("category_id")
  publisher       String?
  publicationYear Int?     @map("publication_year")
  description     String?
  coverImageUrl   String?  @map("cover_image_url")
  totalCopies     Int      @default(1) @map("total_copies")
  availableCopies Int      @default(1) @map("available_copies")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  category  Category?  @relation(fields: [categoryId], references: [id])
  copies    BookCopy[]
  auditLogs AuditLog[]

  @@map("books")
}

// ─── Book Copies ─────────────────────────────────────────────────────────────
model BookCopy {
  id        Int            @id @default(autoincrement())
  bookId    Int            @map("book_id")
  barcode   String?        @unique
  status    BookCopyStatus @default(AVAILABLE)
  location  String?
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")

  book         Book                   @relation(fields: [bookId], references: [id])
  transactions BorrowingTransaction[]

  @@map("book_copies")
}

enum BookCopyStatus {
  AVAILABLE
  BORROWED
  RESERVED
  LOST
  UNAVAILABLE
}

// ─── Borrowing Policies ──────────────────────────────────────────────────────
model BorrowingPolicy {
  id               Int      @id @default(autoincrement())
  roleId           Int      @unique @map("role_id")
  loanDurationDays Int      @default(14) @map("loan_duration_days")
  maxBooksAllowed  Int      @default(3) @map("max_books_allowed")
  createdAt        DateTime @default(now()) @map("created_at")

  role Role @relation(fields: [roleId], references: [id])

  @@map("borrowing_policies")
}

// ─── Borrowing Transactions ──────────────────────────────────────────────────
model BorrowingTransaction {
  id           Int               @id @default(autoincrement())
  bookCopyId   Int               @map("book_copy_id")
  borrowerId   Int               @map("borrower_id")
  librarianId  Int               @map("librarian_id")
  checkoutDate DateTime          @map("checkout_date")
  dueDate      DateTime          @map("due_date")
  returnDate   DateTime?         @map("return_date")
  status       TransactionStatus @default(ACTIVE)
  notes        String?
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")

  bookCopy      BookCopy       @relation(fields: [bookCopyId], references: [id])
  borrower      User           @relation("Borrower", fields: [borrowerId], references: [id])
  librarian     User           @relation("Librarian", fields: [librarianId], references: [id])
  notifications Notification[]

  @@index([borrowerId, status])
  @@map("borrowing_transactions")
}

enum TransactionStatus {
  ACTIVE
  RETURNED
  OVERDUE
}

// ─── Notifications ───────────────────────────────────────────────────────────
model Notification {
  id            Int              @id @default(autoincrement())
  userId        Int              @map("user_id")
  transactionId Int?             @map("transaction_id")
  type          NotificationType
  message       String
  isRead        Boolean          @default(false) @map("is_read")
  sentAt        DateTime         @default(now()) @map("sent_at")

  user        User                  @relation(fields: [userId], references: [id])
  transaction BorrowingTransaction? @relation(fields: [transactionId], references: [id])

  @@map("notifications")
}

enum NotificationType {
  DUE_REMINDER
  OVERDUE_ALERT
  SYSTEM
}

// ─── Audit Logs ──────────────────────────────────────────────────────────────
model AuditLog {
  id         Int      @id @default(autoincrement())
  actorId    Int?     @map("actor_id")
  action     String   // CHECKOUT | RETURN | LOGIN | ROLE_CHANGE | BOOK_EDIT | etc.
  targetType String?  @map("target_type") // book | user | transaction
  targetId   Int?     @map("target_id")
  details    Json?    // before/after values
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")

  actor User?  @relation(fields: [actorId], references: [id])
  book  Book?  @relation(fields: [targetId], references: [id])

  @@map("audit_logs")
}

// ─── Reports ─────────────────────────────────────────────────────────────────
model Report {
  id          Int        @id @default(autoincrement())
  generatedBy Int        @map("generated_by")
  reportType  ReportType @map("report_type")
  fileUrl     String?    @map("file_url")
  generatedAt DateTime   @default(now()) @map("generated_at")

  user User @relation(fields: [generatedBy], references: [id])

  @@map("reports")
}

enum ReportType {
  INVENTORY
  USAGE
  POPULAR_BOOKS
  OVERDUE_TRENDS
}
